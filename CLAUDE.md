# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

CrossPoint Enhanced Reading Mod is custom firmware for the **Xteink X4 e-paper reader**, built on an ESP32-C3 microcontroller using the Arduino framework via PlatformIO. The project's core enhancement is a "Full Mod" button-control system that remaps hardware buttons to apply text formatting (size, spacing, alignment, bold, dark mode, orientation) without opening menus.

## Build Commands

```bash
# Development build
pio run

# Flash to device over USB
pio run --target upload

# Monitor serial output
pio device monitor

# Release build
pio run -e gh_release

# Format all C++ source files
bin/clang-format-fix

# Format only git-modified files
bin/clang-format-fix -g

# Static analysis
pio check --fail-on-defect low --fail-on-defect medium --fail-on-defect high

# Run hyphenation tests
test/run_hyphenation_eval.sh
```

**Code formatting** (clang-format-21) is enforced in CI and must pass before merging. Run `bin/clang-format-fix` before committing.

## Architecture

### Activity-Based State Machine

Each screen is an **Activity** with `onEnter()`, `loop()`, `onExit()` lifecycle methods. Activities are self-contained units that manage their own rendering and input handling, and transition to other activities via callbacks. All activities live in `src/activities/`.

Key activities:
- `EpubReaderActivity` — core EPUB rendering engine
- `HomeActivity`, `MyLibraryActivity` — navigation/file browser
- `CrossPointWebServerActivity` — built-in HTTP file upload server
- `SettingsActivity`, `ButtonRemapActivity` — user preferences and button customization

### Settings Singleton

`CrossPointSettings` (`src/CrossPointSettings.h/cpp`) is a global `SETTINGS` singleton with 16+ enums covering font family/size, line spacing, alignment, button layout, dark mode, etc. All preferences persist to SD card.

### Hardware Abstraction Layer (HAL)

`HalDisplay`, `HalGPIO`, `HalStorage` in `src/` decouple firmware logic from ESP32-C3 hardware specifics. Button mapping goes through `MappedInputManager`, which translates physical button presses to logical actions based on the current remap configuration.

### Libraries (`lib/`)

- `GfxRenderer` — vector graphics and text layout primitives
- `EpdFont` — font rasterization for e-ink; multiple families (Bookerly, Noto Sans, Open Dyslexic) and sizes (12–18pt); compile-time `OMIT_FONTS` flag reduces binary size
- `Epub` — EPUB parsing, CSS rendering, chapter navigation
- `expat`, `miniz`, `picojpeg` — XML parsing, ZIP decompression, JPEG decoding

### Network Features

WiFi activities (`src/network/`) support:
- HTTP file upload web server
- Calibre wireless transfer (OPDS)
- KOReader sync protocol for reading progress
- OTA firmware updates

## Key Files

| File | Purpose |
|---|---|
| `src/main.cpp` | Entry point; hardware init, activity lifecycle, power/sleep states, bootloop detection |
| `src/CrossPointSettings.h/cpp` | All user preferences; singleton pattern |
| `src/MappedInputManager.*` | Button remapping — maps physical → logical actions |
| `platformio.ini` | Board config, build flags, library deps, multi-environment setup |
| `partitions.csv` | ESP32 flash partition layout |
| `scripts/build_html.py` | Pre-build script to embed web UI assets into firmware |

## CI/CD

GitHub Actions runs on every push/PR:
1. **clang-format** check (clang-format-21)
2. **cppcheck** static analysis
3. **Full firmware build** with RAM/Flash stats

Release artifacts (bootloader, firmware ELF/BIN, map files) are generated by tagging a git commit.

## Project Scope

Per `SCOPE.md`, this project deliberately stays focused: document rendering, typography, local file transfer, and library management. Out of scope: web browsing, media playback, highlighting/notes, dictionary lookup, interactive apps.
